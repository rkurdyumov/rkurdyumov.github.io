<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>SecurityPIC.c</title>
</head>
<body style="background-color:#eeeeee">
<pre style="color:#000000; background-color:#eeeeee; font-size:8pt; font-family:'Courier New';"><span style="color:#0080c0; font-weight:bold">#define SECURITY_TEST</span>

<span style="color:#ff8000">/*</span>
<span style="color:#ff8000">Security PIC Module</span>
<span style="color:#ff8000"></span>
<span style="color:#ff8000">This module:</span>
<span style="color:#ff8000">(1) Takes an RFID message from the RFID PIC via SPI, converts ASCII-&gt;HEX</span>
<span style="color:#ff8000">(2) Prepares a message with the serial # for the security controller</span>
<span style="color:#ff8000">(3) Sends it via UART to the security controller</span>
<span style="color:#ff8000">(4) Receives a security key back via UART</span>
<span style="color:#ff8000">(5) Prepares a message with the serial # and security key for the Main PIC</span>
<span style="color:#ff8000"></span>
<span style="color:#ff8000"></span>
<span style="color:#ff8000">*/</span>


<span style="color:#ff8000">/*   PINOUT FOR SECURITY CONTROLLER PIC</span>
<span style="color:#ff8000">******************************************</span>
<span style="color:#ff8000">1  +5V         |VDD  VSS|   GND         20</span>
<span style="color:#ff8000">2  OSC1        |A5    A0|               19</span>
<span style="color:#ff8000">3  OSC2        |A4    A1|               18</span>
<span style="color:#ff8000">4              |A3    A2|               17</span>
<span style="color:#ff8000">5  RFID_READY  |C5    C0|  SS-MAIN		16</span>
<span style="color:#ff8000">6              |C4    C1|               15</span>
<span style="color:#ff8000">7     		   |C3    C2|               14</span>
<span style="color:#ff8000">8  SS-RFID	   |C6    B4|  SPI-SDI      13</span>
<span style="color:#ff8000">9  SPI-SDO     |C7    B5|  RX           12</span>
<span style="color:#ff8000">10 TX          |B7    B6|  SPI-SCK      11</span>
<span style="color:#ff8000">*/</span>

<span style="color:#0080c0; font-weight:bold">#include &lt;htc.h&gt;</span>
<span style="color:#f27900">//#include &quot;pic16f690.h&quot; // for Eric's laptop</span>
<span style="color:#0080c0; font-weight:bold">#include &lt;stdio.h&gt;</span>
<span style="color:#0080c0; font-weight:bold">#define _LEGACY_HEADERS</span>
<span style="color:#0080c0; font-weight:bold">#include</span> <span style="color:#0000ff">&quot;BITDEFS.h&quot;</span><span style="color:#0080c0; font-weight:bold"></span>
<span style="color:#0080c0; font-weight:bold">#include</span> <span style="color:#0000ff">&quot;TimerPIC.h&quot;</span><span style="color:#0080c0; font-weight:bold"></span>

<span style="color:#0080c0; font-weight:bold">#define		SS_RFID				RC0</span>
<span style="color:#0080c0; font-weight:bold">#define		SS_MAIN				RC6</span>
<span style="color:#0080c0; font-weight:bold">#define		DUMMY_BYTE			0xAA</span>
<span style="color:#0080c0; font-weight:bold">#define		RFID_MESSAGE_LENGTH	14</span>
<span style="color:#0080c0; font-weight:bold">#define		RFID_HEX_LENGTH		6</span>
<span style="color:#0080c0; font-weight:bold">#define 	SK_SEND_LENGTH 		5</span>
<span style="color:#0080c0; font-weight:bold">#define		SK_RECEIVE_LENGTH 	6</span>
<span style="color:#0080c0; font-weight:bold">#define		MAIN_SEND_LENGTH	6</span>


<span style="color:#0080c0; font-weight:bold">#ifdef SECURITY_TEST</span>
<span style="color:#004466">__CONFIG</span><span style="color:#ff0080; font-weight:bold">(</span>CP_OFF <span style="color:#ff0080; font-weight:bold">&amp;</span> WDTE_OFF <span style="color:#ff0080; font-weight:bold">&amp;</span> PWRTE_OFF <span style="color:#ff0080; font-weight:bold">&amp;</span> FOSC_HS<span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#0080c0; font-weight:bold">#endif</span>

<span style="color:#0080c0">typedef</span> <span style="color:#8080c0; font-weight:bold">enum</span> <span style="color:#ff0080; font-weight:bold">{</span>
	WAITING_IDLE<span style="color:#ff0080; font-weight:bold">,</span>
	WAITING_FOR_RFID<span style="color:#ff0080; font-weight:bold">,</span>
	SENDING_TO_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">,</span>
	RECEIVING_FROM_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">,</span>
	SENDING_TO_MAIN_PIC
<span style="color:#ff0080; font-weight:bold">}</span> state_t<span style="color:#ff0080; font-weight:bold">;</span>

<span style="color:#f27900">// Function prototypes</span>
<span style="color:#8080c0; font-weight:bold">void</span> interrupt <span style="color:#004466">Security_ISR</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitPins</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitFlags</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitSPI</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitSCI</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitInterrupts</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">Init</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">Update</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">unsigned char</span> <span style="color:#004466">ConvertASCIItoHEX</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">unsigned char</span> upper<span style="color:#ff0080; font-weight:bold">,</span> <span style="color:#8080c0; font-weight:bold">unsigned char</span> lower<span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">unsigned char</span> <span style="color:#004466">VerifyChecksum</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">MakeSecurityMessage</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>
<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">MakeMainMessage</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">);</span>

<span style="color:#f27900">// Module variables</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> RFID_Ready<span style="color:#ff0080; font-weight:bold">;</span>						<span style="color:#f27900">// Flag = set when RFID message available</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> RFID_Message<span style="color:#ff0080; font-weight:bold">[</span>RFID_MESSAGE_LENGTH<span style="color:#ff0080; font-weight:bold">];</span>	<span style="color:#f27900">// Incoming RFID message</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> RFID_Hex<span style="color:#ff0080; font-weight:bold">[</span>RFID_HEX_LENGTH<span style="color:#ff0080; font-weight:bold">];</span>			<span style="color:#f27900">// RFID data converted to HEX</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span>SK_SEND_LENGTH<span style="color:#ff0080; font-weight:bold">];</span> 		<span style="color:#f27900">// Request to Security Controller</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> Security_RX<span style="color:#ff0080; font-weight:bold">[</span>SK_RECEIVE_LENGTH<span style="color:#ff0080; font-weight:bold">];</span> 	<span style="color:#f27900">// Response from Security Controller</span>
<span style="color:#8080c0; font-weight:bold">static unsigned char</span> Main_Message<span style="color:#ff0080; font-weight:bold">[</span>MAIN_SEND_LENGTH<span style="color:#ff0080; font-weight:bold">];</span>	<span style="color:#f27900">// Message to Main PIC</span>

<span style="color:#0080c0; font-weight:bold">#ifdef SECURITY_TEST</span>
<span style="color:#f27900">// Rising edge</span>
<span style="color:#8080c0; font-weight:bold">void</span> interrupt <span style="color:#004466">Security_ISR</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	<span style="color:#f27900">// New RFID message ready</span>
	<span style="color:#bb7977; font-weight:bold">if</span> <span style="color:#ff0080; font-weight:bold">(</span>CCP1IE <span style="color:#ff0080; font-weight:bold">&amp;&amp;</span> CCP1IF<span style="color:#ff0080; font-weight:bold">) {</span>
		CCP1IF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
		RFID_Ready <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#ff0080; font-weight:bold">}</span>
<span style="color:#0080c0; font-weight:bold">#endif</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitPins</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	<span style="color:#f27900">// Turn off analog inputs</span>
	ANSEL <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
	ANSELH <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#f27900">// Set C0 and C6 to be outputs (low)</span>
	TRISC0 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// SS (Main)</span>
	TRISC6 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// SS (RFID)</span>
	TRISB6 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// SCK</span>
	TRISC7 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// SDO</span>
	TRISB7 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// TX</span>
	<span style="color:#f27900">// Don't select either slave yet</span>
	SS_RFID <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	SS_MAIN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitFlags</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	RFID_Ready <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitSPI</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#f27900">// Set up timer 2 for 19.53kHz</span>
	TMR2ON <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#f27900">// Prescaler = 1</span>
	T2CKPS0 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
	T2CKPS1 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#f27900">// Configure SPI</span>
	<span style="color:#ff8000">/* SPI port</span>
<span style="color:#ff8000">	0xxxxxxx = No write collision detect</span>
<span style="color:#ff8000">	x0xxxxxx = No receive overflow indicator</span>
<span style="color:#ff8000">	xx1xxxxx = Enable serial port, SCK, SDO, SDI as serial pins</span>
<span style="color:#ff8000">	xxx1xxxx = Clock idles high</span>
<span style="color:#ff8000">	xxxx0011 = SPI Master, clock = timer2 output/2 (about 10kHz)</span>
<span style="color:#ff8000">	*/</span>
	SSPCON <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span>b00110011<span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#ff8000">/* SPI status register</span>
<span style="color:#ff8000">	0xxxxxxx = Data sampled in middle of output</span>
<span style="color:#ff8000">	x0xxxxxx = Data transmitted on falling edge of SCK</span>
<span style="color:#ff8000">	xxXXXXXX = Read only</span>
<span style="color:#ff8000">	*/</span>
	SSPSTAT <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span>b00000000<span style="color:#ff0080; font-weight:bold">;</span>

	SSPIE <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Turn off SPI interrupt</span>
  	SSPBUF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Clear buffer</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitSCI</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#8080c0; font-weight:bold">unsigned char</span> temp<span style="color:#ff0080; font-weight:bold">;</span>

	TXEN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Enable transmit</span>
  	SYNC <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Turn off synchronous mode</span>
  	TX9 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Disable 9-bit transmission</span>
  	SPEN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Serial port enabled (configures RX/TX as serial port pins)</span>
  	CREN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Continuous receive</span>
  	RX9 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Disable 9-bit receive</span>
  	ADDEN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Turn off address detection</span>
  	BRGH <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// High data rate mode</span>
  	SPBRG <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0x81</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// Set baud rate to 9600</span>
  	SPBRGH <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Clear high baud rate bits</span>

  	temp <span style="color:#ff0080; font-weight:bold">=</span> RCREG<span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// Clear flag in case RCREG was full</span>
  	SSPIF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// Clear before we can send over UART</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">InitInterrupts</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	<span style="color:#f27900">// Capture on every rising edge</span>
	<span style="color:#f27900">// CCP1CON</span>
	CCP1M0 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	CCP1M2 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#f27900">// Enable input capture</span>
	CCP1IE <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#f27900">// Enable Peripheral and Global Interrupts</span>
	INTCON <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
	PEIE <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	GIE <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">Init</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	<span style="color:#004466">InitPins</span><span style="color:#ff0080; font-weight:bold">();</span>
	<span style="color:#004466">InitFlags</span><span style="color:#ff0080; font-weight:bold">();</span>
	<span style="color:#004466">InitSPI</span><span style="color:#ff0080; font-weight:bold">();</span>
	<span style="color:#004466">InitSCI</span><span style="color:#ff0080; font-weight:bold">();</span>
	<span style="color:#004466">InitInterrupts</span><span style="color:#ff0080; font-weight:bold">();</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">Update</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>
	<span style="color:#8080c0; font-weight:bold">static</span> state_t currState <span style="color:#ff0080; font-weight:bold">=</span> WAITING_IDLE<span style="color:#ff0080; font-weight:bold">;</span> 	<span style="color:#f27900">// Initial state</span>
	<span style="color:#8080c0; font-weight:bold">static</span> state_t nextState<span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#8080c0; font-weight:bold">static unsigned int</span> counter <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>			<span style="color:#f27900">// Initial counter</span>

	<span style="color:#f27900">// Assume we stay in the same state unless our SM says otherwise</span>
	nextState <span style="color:#ff0080; font-weight:bold">=</span> currState<span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#bb7977; font-weight:bold">switch</span><span style="color:#ff0080; font-weight:bold">(</span>currState<span style="color:#ff0080; font-weight:bold">) {</span>

		<span style="color:#bb7977; font-weight:bold">case</span> WAITING_IDLE<span style="color:#ff0080; font-weight:bold">:</span>
			<span style="color:#f27900">// If we get a new RFID message</span>
			<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>RFID_Ready<span style="color:#ff0080; font-weight:bold">) {</span>
				<span style="color:#f27900">// Clear flag for next time throughwe</span>
				RFID_Ready <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#f27900">// Select RFID PIC as slave</span>
				SS_RFID <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#f27900">// Send a dummy byte to enable transfer</span>
				SSPBUF <span style="color:#ff0080; font-weight:bold">=</span> DUMMY_BYTE<span style="color:#ff0080; font-weight:bold">;</span>
				counter<span style="color:#ff0080; font-weight:bold">++;</span>
				nextState <span style="color:#ff0080; font-weight:bold">=</span> WAITING_FOR_RFID<span style="color:#ff0080; font-weight:bold">;</span>
			<span style="color:#ff0080; font-weight:bold">}</span>
		<span style="color:#bb7977; font-weight:bold">break</span><span style="color:#ff0080; font-weight:bold">;</span>

		<span style="color:#bb7977; font-weight:bold">case</span> WAITING_FOR_RFID<span style="color:#ff0080; font-weight:bold">:</span>
			<span style="color:#f27900">// Once we get a response from RFID PIC</span>
			<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>BF<span style="color:#ff0080; font-weight:bold">) {</span>
				<span style="color:#f27900">// If it's not our last byte</span>
				<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>counter <span style="color:#ff0080; font-weight:bold">&lt;</span> RFID_MESSAGE_LENGTH<span style="color:#ff0080; font-weight:bold">) {</span>
					<span style="color:#f27900">// Get byte, clears BF</span>
					RFID_Message<span style="color:#ff0080; font-weight:bold">[</span>counter<span style="color:#ff0080; font-weight:bold">-</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">] =</span> SSPBUF<span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// Send a dummy byte to enable transfer</span>
					SSPBUF <span style="color:#ff0080; font-weight:bold">=</span> DUMMY_BYTE<span style="color:#ff0080; font-weight:bold">;</span>
					counter<span style="color:#ff0080; font-weight:bold">++;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
				<span style="color:#f27900">// If we got our last byte</span>
				<span style="color:#bb7977; font-weight:bold">else</span> <span style="color:#ff0080; font-weight:bold">{</span>
					<span style="color:#f27900">// Get byte, clears BF</span>
					RFID_Message<span style="color:#ff0080; font-weight:bold">[</span>counter<span style="color:#ff0080; font-weight:bold">-</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">] =</span> SSPBUF<span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// Done</span>
					counter <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// De-select RFID PIC as slave</span>
					SS_RFID <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// If checksum passes, return 0,</span>
					<span style="color:#f27900">// VerifyCheckSum also converts the ASCII data to HEX</span>
					<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#004466">VerifyChecksum</span><span style="color:#ff0080; font-weight:bold">() ==</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">) {</span>
						<span style="color:#f27900">// Prepare message to Security Controller</span>
						<span style="color:#004466">MakeSecurityMessage</span><span style="color:#ff0080; font-weight:bold">();</span>
						<span style="color:#f27900">// Wait for xmit register to empty, technically blocking code,</span>
						<span style="color:#f27900">// but TXIF should never be 0 here</span>
						<span style="color:#bb7977; font-weight:bold">while</span><span style="color:#ff0080; font-weight:bold">(!</span>TXIF<span style="color:#ff0080; font-weight:bold">);</span>
						<span style="color:#f27900">// Send out the first byte</span>
						TXREG <span style="color:#ff0080; font-weight:bold">=</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">];</span>
						counter<span style="color:#ff0080; font-weight:bold">++;</span>
						nextState <span style="color:#ff0080; font-weight:bold">=</span> SENDING_TO_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#ff0080; font-weight:bold">}</span>
					<span style="color:#bb7977; font-weight:bold">else</span>
						nextState <span style="color:#ff0080; font-weight:bold">=</span> WAITING_IDLE<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
				BF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>		<span style="color:#f27900">// probably not needed</span>
				SSPIF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// Clear so that Main PIC message sends</span>
			<span style="color:#ff0080; font-weight:bold">}</span>
		<span style="color:#bb7977; font-weight:bold">break</span><span style="color:#ff0080; font-weight:bold">;</span>

		<span style="color:#bb7977; font-weight:bold">case</span> SENDING_TO_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">:</span>
			<span style="color:#f27900">// If Xmit register empty</span>
			<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>TXIF<span style="color:#ff0080; font-weight:bold">) {</span>
				<span style="color:#f27900">// Send out message</span>
				<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>counter <span style="color:#ff0080; font-weight:bold">&lt;</span> SK_SEND_LENGTH<span style="color:#ff0080; font-weight:bold">) {</span>
					TXREG <span style="color:#ff0080; font-weight:bold">=</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span>counter<span style="color:#ff0080; font-weight:bold">];</span>
					counter<span style="color:#ff0080; font-weight:bold">++;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
				<span style="color:#f27900">// Done sending out message</span>
				<span style="color:#bb7977; font-weight:bold">else</span> <span style="color:#ff0080; font-weight:bold">{</span>
					counter <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
					nextState <span style="color:#ff0080; font-weight:bold">=</span> RECEIVING_FROM_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
			<span style="color:#ff0080; font-weight:bold">}</span>
		<span style="color:#bb7977; font-weight:bold">break</span><span style="color:#ff0080; font-weight:bold">;</span>

		<span style="color:#bb7977; font-weight:bold">case</span> RECEIVING_FROM_SECURITY_PIC<span style="color:#ff0080; font-weight:bold">:</span>
			<span style="color:#f27900">// If we got another byte from Security Controller</span>
			<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>RCIF<span style="color:#ff0080; font-weight:bold">) {</span>
				<span style="color:#f27900">// Get the bytes, clears RCIF</span>
				Security_RX<span style="color:#ff0080; font-weight:bold">[</span>counter<span style="color:#ff0080; font-weight:bold">] =</span> RCREG<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#f27900">// Not done yet</span>
				<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>counter <span style="color:#ff0080; font-weight:bold">&lt; (</span>SK_RECEIVE_LENGTH <span style="color:#ff0080; font-weight:bold">-</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">))</span>
					counter<span style="color:#ff0080; font-weight:bold">++;</span>
				<span style="color:#f27900">// Get the last (6th) byte</span>
				<span style="color:#bb7977; font-weight:bold">else if</span> <span style="color:#ff0080; font-weight:bold">(</span>counter <span style="color:#ff0080; font-weight:bold">==</span> SK_RECEIVE_LENGTH<span style="color:#ff0080; font-weight:bold">-</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">) {</span>

					counter <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// Select SS of Main PIC</span>
					SS_MAIN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// Prepare message to Main PIC</span>
					<span style="color:#004466">MakeMainMessage</span><span style="color:#ff0080; font-weight:bold">();</span>
					SSPBUF <span style="color:#ff0080; font-weight:bold">=</span> Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">];</span>
					counter<span style="color:#ff0080; font-weight:bold">++;</span>
					nextState <span style="color:#ff0080; font-weight:bold">=</span> SENDING_TO_MAIN_PIC<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
			<span style="color:#ff0080; font-weight:bold">}</span>
		<span style="color:#bb7977; font-weight:bold">break</span><span style="color:#ff0080; font-weight:bold">;</span>

		<span style="color:#bb7977; font-weight:bold">case</span> SENDING_TO_MAIN_PIC<span style="color:#ff0080; font-weight:bold">:</span>
			<span style="color:#f27900">// If finished last transmission</span>
			<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>SSPIF <span style="color:#ff0080; font-weight:bold">&amp;&amp;</span> BF<span style="color:#ff0080; font-weight:bold">) {</span>
				<span style="color:#f27900">// Read SSPBUF garbage to clear BF</span>
				SSPBUF<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#f27900">// Manually clear flag</span>
				SSPIF <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#f27900">// Send the rest of the message</span>
				<span style="color:#bb7977; font-weight:bold">if</span><span style="color:#ff0080; font-weight:bold">(</span>counter <span style="color:#ff0080; font-weight:bold">&lt;</span> MAIN_SEND_LENGTH<span style="color:#ff0080; font-weight:bold">) {</span>
					SSPBUF <span style="color:#ff0080; font-weight:bold">=</span> Main_Message<span style="color:#ff0080; font-weight:bold">[</span>counter<span style="color:#ff0080; font-weight:bold">];</span>
					counter<span style="color:#ff0080; font-weight:bold">++;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
				<span style="color:#bb7977; font-weight:bold">else</span> <span style="color:#ff0080; font-weight:bold">{</span>
					counter <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>
					<span style="color:#f27900">// Deselect SS of Main PIC</span>
					SS_MAIN <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
					nextState <span style="color:#ff0080; font-weight:bold">=</span> WAITING_IDLE<span style="color:#ff0080; font-weight:bold">;</span>
				<span style="color:#ff0080; font-weight:bold">}</span>
				<span style="color:#f27900">// Done</span>
			<span style="color:#ff0080; font-weight:bold">}</span>
		<span style="color:#bb7977; font-weight:bold">break</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#ff0080; font-weight:bold">}</span>
	currState <span style="color:#ff0080; font-weight:bold">=</span> nextState<span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">unsigned char</span> <span style="color:#004466">ConvertASCIItoHEX</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">unsigned char</span> upper<span style="color:#ff0080; font-weight:bold">,</span> <span style="color:#8080c0; font-weight:bold">unsigned char</span> lower<span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#8080c0; font-weight:bold">static unsigned char</span> hex<span style="color:#ff0080; font-weight:bold">,</span> lower_hex<span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#f27900">// Upper nibble: if &lt; 0x40, AND w/ 0x0F, otherwise subtract 0x37, then bit shift</span>
	hex <span style="color:#ff0080; font-weight:bold">= (</span>upper <span style="color:#ff0080; font-weight:bold">&lt;</span> <span style="color:#800080; font-weight:bold">0x40</span><span style="color:#ff0080; font-weight:bold">)</span>?<span style="color:#ff0080; font-weight:bold">(</span>upper <span style="color:#ff0080; font-weight:bold">&amp;</span> <span style="color:#800080; font-weight:bold">0x0F</span><span style="color:#ff0080; font-weight:bold">):(</span>upper <span style="color:#ff0080; font-weight:bold">-</span> <span style="color:#800080; font-weight:bold">0x37</span><span style="color:#ff0080; font-weight:bold">);</span>
	hex <span style="color:#ff0080; font-weight:bold">=</span> hex<span style="color:#ff0080; font-weight:bold">&lt;&lt;</span><span style="color:#800080; font-weight:bold">4</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#f27900">// Lower nibble: same as above, without bit shift, add to upper to get full HEX</span>
	lower_hex <span style="color:#ff0080; font-weight:bold">= (</span>lower <span style="color:#ff0080; font-weight:bold">&lt;</span> <span style="color:#800080; font-weight:bold">0x40</span><span style="color:#ff0080; font-weight:bold">)</span>?<span style="color:#ff0080; font-weight:bold">(</span>lower <span style="color:#ff0080; font-weight:bold">&amp;</span> <span style="color:#800080; font-weight:bold">0x0F</span><span style="color:#ff0080; font-weight:bold">):(</span>lower <span style="color:#ff0080; font-weight:bold">-</span> <span style="color:#800080; font-weight:bold">0x37</span><span style="color:#ff0080; font-weight:bold">);</span>
	hex <span style="color:#ff0080; font-weight:bold">+=</span> lower_hex<span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#bb7977; font-weight:bold">return</span> hex<span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">unsigned char</span> <span style="color:#004466">VerifyChecksum</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#8080c0; font-weight:bold">static unsigned char</span> i<span style="color:#ff0080; font-weight:bold">,</span> checksum<span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#f27900">// Convert received ASCII characters to HEX</span>
	<span style="color:#bb7977; font-weight:bold">for</span><span style="color:#ff0080; font-weight:bold">(</span>i<span style="color:#ff0080; font-weight:bold">=</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">&lt;</span>RFID_HEX_LENGTH<span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">++)</span>
		RFID_Hex<span style="color:#ff0080; font-weight:bold">[</span>i<span style="color:#ff0080; font-weight:bold">] =</span> <span style="color:#004466">ConvertASCIItoHEX</span><span style="color:#ff0080; font-weight:bold">(</span>RFID_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">*</span>i<span style="color:#ff0080; font-weight:bold">+</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">],</span> RFID_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">*</span>i<span style="color:#ff0080; font-weight:bold">+</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">]);</span>
	<span style="color:#f27900">// Calculate the checksum:</span>
	<span style="color:#f27900">// XOR all the converted HEX values after the start of data ASCII charactr (0x02)</span>
	checksum <span style="color:#ff0080; font-weight:bold">=</span> RFID_Hex<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">];</span>
	<span style="color:#bb7977; font-weight:bold">for</span><span style="color:#ff0080; font-weight:bold">(</span>i<span style="color:#ff0080; font-weight:bold">=</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">&lt;</span>RFID_HEX_LENGTH<span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">++)</span>
		checksum ^<span style="color:#ff0080; font-weight:bold">=</span> RFID_Hex<span style="color:#ff0080; font-weight:bold">[</span>i<span style="color:#ff0080; font-weight:bold">];</span>
 	<span style="color:#f27900">// Should return 0 if we had a valid checksum since our last operation was XOR w/ checksum</span>
	<span style="color:#bb7977; font-weight:bold">return</span> checksum<span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">MakeSecurityMessage</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#8080c0; font-weight:bold">static unsigned char</span> i<span style="color:#ff0080; font-weight:bold">;</span>

	Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">] =</span> <span style="color:#800080; font-weight:bold">0x04</span><span style="color:#ff0080; font-weight:bold">;</span>
	<span style="color:#bb7977; font-weight:bold">for</span> <span style="color:#ff0080; font-weight:bold">(</span>i<span style="color:#ff0080; font-weight:bold">=</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">&lt;</span><span style="color:#800080; font-weight:bold">4</span><span style="color:#ff0080; font-weight:bold">;</span> i<span style="color:#ff0080; font-weight:bold">++)</span>
		Security_TX<span style="color:#ff0080; font-weight:bold">[</span>i<span style="color:#ff0080; font-weight:bold">]=</span> RFID_Hex<span style="color:#ff0080; font-weight:bold">[</span>i<span style="color:#ff0080; font-weight:bold">+</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">];</span>
	Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">4</span><span style="color:#ff0080; font-weight:bold">] =</span> <span style="color:#800080; font-weight:bold">0x08</span><span style="color:#ff0080; font-weight:bold">;</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">MakeMainMessage</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#f27900">// S1-S3</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">];</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">];</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_TX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">3</span><span style="color:#ff0080; font-weight:bold">];</span>
	<span style="color:#f27900">// SK1-SK3</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">3</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_RX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">];</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">4</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_RX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">2</span><span style="color:#ff0080; font-weight:bold">];</span>
	Main_Message<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">5</span><span style="color:#ff0080; font-weight:bold">] =</span> Security_RX<span style="color:#ff0080; font-weight:bold">[</span><span style="color:#800080; font-weight:bold">4</span><span style="color:#ff0080; font-weight:bold">];</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#0080c0; font-weight:bold">#ifdef SECURITY_TEST</span>

<span style="color:#8080c0; font-weight:bold">void</span> <span style="color:#004466">main</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#8080c0; font-weight:bold">void</span><span style="color:#ff0080; font-weight:bold">) {</span>

	<span style="color:#004466">Init</span><span style="color:#ff0080; font-weight:bold">();</span>
	<span style="color:#004466">TimerPIC_Init</span><span style="color:#ff0080; font-weight:bold">();</span>
	GIE <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>
	TRISA1 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">0</span><span style="color:#ff0080; font-weight:bold">;</span>	<span style="color:#f27900">// test output</span>

	<span style="color:#f27900">//TimerPIC_InitTimer(7,200);</span>
	RA1 <span style="color:#ff0080; font-weight:bold">=</span> <span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">;</span>

	<span style="color:#bb7977; font-weight:bold">while</span><span style="color:#ff0080; font-weight:bold">(</span><span style="color:#800080; font-weight:bold">1</span><span style="color:#ff0080; font-weight:bold">) {</span>
		<span style="color:#004466">Update</span><span style="color:#ff0080; font-weight:bold">();</span>
		<span style="color:#ff8000">/*</span>
<span style="color:#ff8000">		if(TimerPIC_IsTimerExpired(7) == TimerPIC_EXPIRED){</span>
<span style="color:#ff8000">			TimerPIC_ClearTimerExpired(7);</span>
<span style="color:#ff8000">			TimerPIC_InitTimer(7,200);</span>
<span style="color:#ff8000">			RA1 ^= 1;</span>
<span style="color:#ff8000">		}</span>
<span style="color:#ff8000">*/</span>
	<span style="color:#ff0080; font-weight:bold">}</span>
<span style="color:#ff0080; font-weight:bold">}</span>

<span style="color:#0080c0; font-weight:bold">#endif</span>
</pre>
</body>
</html>
<!--HTML generated by highlight 2.13, http://www.andre-simon.de/-->
